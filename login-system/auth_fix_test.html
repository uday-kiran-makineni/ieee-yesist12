<!DOCTYPE html>
<html>
<head>
    <title>Auth Handler Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Auth Handler Fix Test</h1>
    
    <h2>Test 1: Basic Auth Handler Test</h2>
    <button onclick="testAuthHandler()">Test Auth Handler</button>
    <div id="auth-result"></div>
    
    <h2>Test 2: Signup Test</h2>
    <button onclick="testSignup()">Test Signup Process</button>
    <div id="signup-result"></div>
    
    <h2>Test 3: Check Response Format</h2>
    <button onclick="checkResponseFormat()">Check Raw Response</button>
    <div id="format-result"></div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function showResultWithDetails(elementId, message, details, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="result ${type}">
                    ${message}
                    <pre>${JSON.stringify(details, null, 2)}</pre>
                </div>
            `;
        }

        async function testAuthHandler() {
            showResult('auth-result', 'üîÑ Testing auth handler...', 'info');
            
            try {
                const response = await fetch('auth_handler.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'test' })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                try {
                    const result = JSON.parse(text);
                    showResultWithDetails('auth-result', '‚úÖ Auth handler working - Valid JSON response', {
                        status: response.status,
                        response: result
                    }, 'success');
                } catch (jsonError) {
                    showResultWithDetails('auth-result', '‚ùå Auth handler returning invalid JSON', {
                        status: response.status,
                        rawResponse: text.substring(0, 200) + (text.length > 200 ? '...' : ''),
                        jsonError: jsonError.message
                    }, 'error');
                }
            } catch (error) {
                showResultWithDetails('auth-result', '‚ùå Auth handler network error', {
                    error: error.message,
                    type: error.name
                }, 'error');
            }
        }

        async function testSignup() {
            showResult('signup-result', 'üîÑ Testing signup process...', 'info');
            
            const signupData = {
                action: 'signup',
                email: 'test_' + Date.now() + '@example.com',
                password: 'TestPassword123!',
                fullName: 'Test User Fix',
                phone: '+1234567890'
            };
            
            try {
                const response = await fetch('auth_handler.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(signupData)
                });
                
                const text = await response.text();
                console.log('Signup raw response:', text);
                
                try {
                    const result = JSON.parse(text);
                    if (result.success) {
                        showResultWithDetails('signup-result', '‚úÖ Signup successful!', {
                            request: signupData,
                            response: result
                        }, 'success');
                    } else {
                        showResultWithDetails('signup-result', '‚ö†Ô∏è Signup failed (but JSON is valid)', {
                            request: signupData,
                            response: result
                        }, 'info');
                    }
                } catch (jsonError) {
                    showResultWithDetails('signup-result', '‚ùå Signup returning invalid JSON', {
                        request: signupData,
                        rawResponse: text.substring(0, 200) + (text.length > 200 ? '...' : ''),
                        jsonError: jsonError.message
                    }, 'error');
                }
            } catch (error) {
                showResultWithDetails('signup-result', '‚ùå Signup network error', {
                    request: signupData,
                    error: error.message,
                    type: error.name
                }, 'error');
            }
        }

        async function checkResponseFormat() {
            showResult('format-result', 'üîÑ Checking response format...', 'info');
            
            try {
                const response = await fetch('auth_handler.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'invalid' })
                });
                
                const text = await response.text();
                
                showResultWithDetails('format-result', 'Raw Response Analysis', {
                    status: response.status,
                    contentType: response.headers.get('content-type'),
                    responseLength: text.length,
                    firstChar: text.charAt(0),
                    startsWithJson: text.charAt(0) === '{' || text.charAt(0) === '[',
                    containsHtml: text.includes('<'),
                    fullResponse: text
                }, text.charAt(0) === '{' ? 'success' : 'error');
                
            } catch (error) {
                showResult('format-result', '‚ùå Format check failed: ' + error.message, 'error');
            }
        }

        // Auto-run the auth handler test on page load
        window.addEventListener('load', function() {
            setTimeout(testAuthHandler, 500);
        });
    </script>
</body>
</html>